!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("ARTE",[],t):"object"==typeof exports?exports.ARTE=t():e.ARTE=t()}(self,(function(){return(()=>{"use strict";var e={d:(t,n)=>{for(var o in n)e.o(n,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:n[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{default:()=>nt});var n={};e.r(n),e.d(n,{REDO:()=>M,UNDO:()=>D,ignore:()=>I,update:()=>H});var o={};e.r(o),e.d(o,{BQ:()=>ae,H1:()=>te,H2:()=>ne,H3:()=>oe,OL:()=>ie,P:()=>re,UL:()=>le});var r={};e.r(r),e.d(r,{B:()=>pe,CLEAR:()=>me,I:()=>he,U:()=>ge,click:()=>ue});var a={};e.r(a),e.d(a,{BUTTON:()=>ke,setup:()=>Se});var i={};e.r(i),e.d(i,{BUTTON:()=>Re});var l={};e.r(l),e.d(l,{BACKGROUND:()=>Ve,FOREGROUND:()=>je});var s={};e.r(s),e.d(s,{BUTTON:()=>tt});let c={block:["DIV","P","LI"],list:["LI"],custom:[]};const d=function(e){return null!=e.tagName&&"SPAN"===e.tagName},u=function(e){return void 0!==e.tagName&&("OL"===e.tagName||"UL"===e.tagName)},f=function(e){return null!=e.tagName&&c.block.includes(e.tagName)},p=function(e){const t=e.blockParent.firstElementChild;return!(null==t||!h(t))&&t},h=function(e){return null!=e.tagName&&c.custom.includes(e.tagName)},g=function(e){for(;0==f(e);)e=e.parentNode;return e},m=function(e,t){let n=e;for(;e!=t;)n=e,e=e.parentNode;return n},b=function(e,t){if(3!==e.nodeType)if(1===e.nodeType)if(!1!==f(e)||!1!==u(e)||!1!==d(e)||!1!==h(e))if(t.length>0&&h(e)){const n=t.find((t=>t.tag.toUpperCase()===e.tagName));if(n&&"clean"in n){const t=n.clean(e);e.parentNode.replaceChild(t,e)}}else e.childNodes.forEach((e=>{b(e,t)}));else e.remove();else e.remove();else e.textContent.includes("\n")&&(e.textContent=e.textContent.trim())},y="§§",v="±±";let C=null,L=0,E=null,N=0;function S(e){return e.blockParent=g(e.commonAncestorContainer),e.rootNode=e.commonAncestorContainer,3===e.commonAncestorContainer.nodeType&&(e.rootNode=e.commonAncestorContainer.parentNode),e}const k=function(){if(null===document.querySelector(".show")){let e=window.getSelection();if(1==e.rangeCount){let t=e.getRangeAt(0);return t=S(t),t}}return!1},T=function(e,t){let n=document.createRange();const o=window.getSelection();return t>e.textContent.length&&(t=0),n.setStart(e,t),n.collapse(!0),o.removeAllRanges(),o.addRange(n),n=S(n),n};function w(e,t){for(let n=0;n<e.childNodes.length;n++){const o=e.childNodes[n];if(1===o.nodeType){if(w(o,t))return!0}else if(3===o.nodeType){const e=o.textContent.indexOf(t);if(-1!=e)return o.textContent=o.textContent.replace(t,""),t==y?(C=o,L=e):(E=o,N=e),!0}}return!1}const x=function(e){if(w(e,y)&&w(e,v)){const e=document.createRange(),t=window.getSelection();return e.setStart(C,L),C==E&&L==N?e.collapse(!0):e.setEnd(E,N),t.removeAllRanges(),t.addRange(e),e}return!1},q=function(){return Date.now().toString(36)+Math.random().toString(36).substr(2)},A=class{constructor(e,t,n,o,r,a){this.type=e,this.tag=t,this.label=n,this.input="button",this.icon=o,this.click=r,this.element=null,null!=a&&Object.keys(a).forEach((e=>{this[e]=a[e]}))}},O=function(e,t){"UNDO"==t.tag?t.element.disabled=e.buffer.length<=1||e.bufferIndex<=0:t.element.disabled=e.bufferIndex>=e.buffer.length-1},H=function(e){if(0!=e.options.bufferSize){if(e.buffer.length>e.options.bufferSize&&e.buffer.shift(),e.bufferIndex+1<e.buffer.length){const t=e.buffer.length-(e.bufferIndex+1);for(let n=0;n<t;n++)e.buffer.pop()}e.buffer.push(e.editorNode.innerHTML),e.bufferIndex=e.buffer.length-1,O(e,D),O(e,M)}},I=function(e){let t=e.bufferIgnore;return e.bufferIgnore=!1,t},$={setState:O},D=new A("buffer","UNDO","Undo",'<i class="bi bi-reply"></i>',(function(e){e.bufferIndex>0&&(e.bufferIndex--,e.bufferIgnore=!0,e.editorNode.innerHTML=e.buffer[e.bufferIndex]),O(e,D),O(e,M),console.log("buffer",e.buffer),console.log("buffer index",e.bufferIndex),e.updateEventHandlers()}),$),M=new A("buffer","REDO","Redo",'<span style="display:inline-block;-webkit-transform: scale(-1, 1);transform: scale(-1, 1);"><i class="bi bi-reply"></i></span>',(function(e){e.bufferIndex+1<e.buffer.length&&(e.bufferIndex++,e.bufferIgnore=!0,e.editorNode.innerHTML=e.buffer[e.bufferIndex]),O(e,D),O(e,M),console.log("buffer",e.buffer),console.log("buffer index",e.bufferIndex),e.updateEventHandlers()}),$);let P=null;const R=function(e,t){P=document.createElement("DIV"),P.classList.add("modal-panel"),P.innerHTML=function(e,t){return`\n        <div class="modal-panel-container">\n            <header class="modal-panel-header">\n                <h3 class="modal-panel-title">${e}</h3>\n            </header>\n            <div class="modal-panel-message">${t}</div>\n            <div class="modal-panel-buttons">\n                <button type="button" class="btn btn-success close">Close</button>\n            </div>\n        </div>`}(e,t),P.querySelector("button").addEventListener("click",(e=>{e.stopPropagation(),P.classList.remove("show"),setTimeout((()=>{P.remove(),P=null}),500)})),document.querySelector("body").appendChild(P),setTimeout((()=>{P.classList.add("show")}),10)};let F,B,U="";const K=function(e,t){F=e.startContainer,B=e.endContainer,t&&(F=g(F),B=g(B)),U="pre"},j=function(e){e==F?(U="first",e==B&&(U="both")):e==B?U="last":"first"==U?U="during":"both"==U||"last"==U?U="post-first":"post-first"==U&&(U="post")},V=function(){return"pre"==U},z=function(){return"first"==U||"both"==U},G=function(){return"during"==U||"first"==U||"last"==U||"both"==U},W=function(){return"post-first"==U||"post"==U};let Y,_,Q=[],J=!1;function X(e,t,n){let o={oldFormats:[],newFormats:[]};e!=Y&&(j(e),o=function(e,t,n){const o=[...t.oldFormats,e.tagName];let r=[];return V()||W()?(r=[...o],{newFormats:r,oldFormats:o}):"block"===n.type?(r=[n.newFormat],{newFormats:r,oldFormats:o}):z()?("LI"==e.tagName?e.parentNode.firstElementChild==e?(r.pop(),r.push(n.newFormat),r.push("LI"),console.log("3.1.2 new list formats",t.newFormats.join(" "))):(r=t.oldFormats.slice(),r.push(n.newFormat),r.push("LI"),console.log("3.1.4 new list formats",t.newFormats.join(" "))):(r.push(n.newFormat),r.push("LI")),{newFormats:r,oldFormats:o}):(r=Q.slice(),{newFormats:r,oldFormats:o})}(e,t,n),function(e,t){let n,o=_,r=function(e){let t="";return e.childNodes.forEach((e=>{if(3===e.nodeType){let n=e.textContent;n.includes("\n")&&(n=n.trim()),t+=n}else(d(e)||h(e)||"BR"===e.tagName)&&(t+=e.outerHTML)})),t}(e),a=[];a=G()?t.newFormats:t.oldFormats;let i=a.slice(-1)[0];if(e.nodeType,!(1!==e.nodeType||""==r&&e.innerHTML.includes("<"))){if(0==Q.length)a.forEach((e=>{n=document.createElement(e),o=o.appendChild(n)}));else if(a.length>Q.length){if(console.log("saveContent: 2. Current formats longer than previous formats"),l=a,Q.every(((e,t)=>l[t]==e))){for(let e=0;e<Q.length;e++)o=o.lastElementChild;for(let e=Q.length;e<a.length;e++)n=document.createElement(a[e]),o=o.appendChild(n)}}else(function(e,t){return(0==e.length||0==t.length||e.length==t.length)&&e.every(((e,n)=>t[n]==e))})(a,Q)&&(J&&J!=_&&(o=J.parentNode),n=document.createElement(i),o=o.appendChild(n));if(o==_){let e=0;a.forEach(((t,n)=>{t==Q[n]&&0==(n==a.length-1&&"LI"==t)&&(o=o.lastElementChild,e++)}));for(let t=e;t<a.length;t++)n=document.createElement(a[t]),o=o.appendChild(n)}J=o,Q=a.slice(),""!=r&&(o.innerHTML=r)}var l}(e,o)),e.childNodes.forEach((e=>{(f(e)||u(e))&&X(e,o,n)}))}const Z=function(e,t){const n=e.range;Y=e.editorNode,Q=[],J=!1,function(e){e.action="apply",("CLEAR"==e.tag||e.element.getAttribute("data-active"))&&(e.action="remove"),e.newFormat=e.tag,"block"==e.type&&"remove"==e.action&&(e.newFormat="P")}(t),n.rootNode=m(n.rootNode,Y);const o=m(n.startContainer,Y),r=m(n.endContainer,Y);if(function(e){e.startContainer==e.endContainer?e.startContainer.textContent=e.startContainer.textContent.substring(0,e.startOffset)+y+e.startContainer.textContent.substring(e.startOffset,e.endOffset)+v+e.startContainer.textContent.substring(e.endOffset):(e.startContainer.textContent=e.startContainer.textContent.substring(0,e.startOffset)+y+e.startContainer.textContent.substring(e.startOffset),e.endContainer.textContent=e.endContainer.textContent.substring(0,e.endOffset)+v+e.endContainer.textContent.substring(e.endOffset))}(n),K(n,!0),o==r)_=document.createElement("DIV"),X(o,{oldFormats:[],newFormats:[]},t),o==Y?o.innerHTML=_.innerHTML:o.outerHTML=_.innerHTML;else{let e=!1,a=!1;_=document.createElement("DIV"),n.rootNode.childNodes.forEach((n=>{1===n.nodeType&&(n==o&&(e=!0),e&&0==a&&("block"===t.type&&(Q=[],J=!1,_=document.createElement("DIV")),X(n,{oldFormats:[],newFormats:[]},t),"block"===t.type?n.outerHTML=_.innerHTML:n.setAttribute("data-remove",!0)),n==r)&&(a=!0,"list"===t.type&&(console.log("fragment",_.innerHTML),n.outerHTML=_.innerHTML),Y.querySelectorAll("[data-remove=true]").forEach((e=>e.remove())))}))}x(e.editorNode),e.updateRange(),t.setState(e,t)},ee={setState:function(e,t){if(!1===e.range)t.element.disabled=!0,t.element.classList.remove("active");else if("CLEAR"==t.tag)t.element.disabled=!1,t.element.classList.remove("active");else{let n=g(e.range.startContainer,e.editorNode);t.element.disabled="DIV"===n.tagName||h(n),"list"===t.type&&"LI"===n.tagName&&(n=n.parentNode),n.tagName===t.tag?t.element.classList.add("active"):t.element.classList.remove("active")}}},te=new A("block","H1","Heading 1",'<i class="bi bi-type-h1"></i>',Z,ee),ne=new A("block","H2","Heading 2",'<i class="bi bi-type-h2"></i>',Z,ee),oe=new A("block","H3","Heading 3",'<i class="bi bi-type-h3"></i>',Z,ee),re=new A("block","P","Paragraph",'<i class="bi bi-paragraph"></i>',Z,ee),ae=new A("block","BLOCKQUOTE","Blockquote",'<i class="bi bi-blockquote-left"></i>',Z,ee),ie=new A("list","OL","Ordered list",'<i class="bi bi-list-ol"></i>',Z,ee),le=new A("list","UL","Unordered list",'<i class="bi bi-list-ul"></i>',Z,ee);const se=function(e,t){!1===e.range||0==e.range.collapsed&&e.range.startContainer!=e.range.endContainer?(t.element.disabled=!0,t.element.classList.remove("active")):"CLEAR"==t.tag?(t.element.disabled=!1,t.element.classList.remove("active")):(t.element.disabled="DIV"===e.range.rootNode.tagName||u(e.range.rootNode)||h(e.range.rootNode),de(t),!function(e){let t="";for(;0==f(e);){if(1===e.nodeType){const n=e.getAttribute("style");null!=n&&""!=n&&(t+=";"+n)}e=e.parentNode}return t}(e.range.startContainer).includes(t.style)?t.element.classList.remove("active"):t.element.classList.add("active"))},ce=function(e,t,n,o){return console.log("Parsing node",e),3===e.nodeType?function(e,t,n,o){j(e);let r="",a="",i="",l="",s="";if(G())if("apply"==n.action){let e=-1;t.forEach(((t,o)=>{t.split(":")[0].trim()==n.newStyle&&(e=o)})),-1!=e&&(t=t.filter((t=>t!=e)));const o=`${n.newStyle}:${n.newValue}`;l=`<span style="${(t=[...t,o]).join(";")}">`,s="</span>"}else"CLEAR"!=style&&(t=t.filter((e=>e.split(":")[0].trim()!=style))).length>0&&(l=`<span style="${t.join(";")};${n.removeStyle}">`,s="</span>");else t.length>0&&(l=`<span style="${t.join(";")}">`,s="</span>");return V()||W()?l+e.textContent+s:"both"==U?(a=e.textContent.substring(0,o.startOffset),r=y+e.textContent.substring(o.startOffset,o.endOffset)+v,i=e.textContent.substring(o.endOffset),a+l+r+s+i):z()?(a=e.textContent.substring(0,o.startOffset),r=y+e.textContent.substring(o.startOffset),a+l+r+s):"last"==U?(r=e.textContent.substring(0,o.endOffset)+v,i=e.textContent.substring(o.endOffset),l+r+s+i):G()?l+e.textContent+s:(console.warn("Error: Found a missing state with node",e),"")}(e,t,n,o):h(e)?e.outerHTML:function(e,t,n,o){if("SPAN"===e.tagName){const n=e.getAttribute("style");null!=n&&""!=n&&n.split(";").forEach((e=>{if(""!=e){const n=e.split(":");0==t.includes(n[0].trim())&&(t=[...t,e])}}))}let r="";return e.childNodes.forEach((e=>{r+=ce(e,t,n,o)})),console.log("Returning block html",r),r}(e,t,n,o)},de=function(e){const t=e.style.split(":");e.newStyle=t[0],e.newValue=void 0!==t[1]?t[1]:"",e.action="apply",(e.element.classList.contains("active")||"CLEAR"==e.style)&&(e.action="remove")},ue=function(e,t){const n=e.range;0==f(n.rootNode)&&(n.rootNode=g(n.rootNode)),de(t),K(n,!1);const o=ce(n.rootNode,[],t,n);console.log("html",o),function(e,t,n){const o=document.createElement(t);o.innerHTML=n;e.parentNode.insertBefore(o,e);e.parentNode.removeChild(e)}(n.rootNode,n.rootNode.tagName,o),x(e.editorNode),e.updateRange(),t.setState(e,t)};let fe={setState:se,style:"font-weight:bold",removeStyle:"font-weight:400"};const pe=new A("style","B","Bold",'<i class="bi bi-type-bold"></i>',ue,fe);fe={setState:se,style:"font-style:italic",removeStyle:"font-style:normal"};const he=new A("style","I","Italic",'<i class="bi bi-type-italic"></i>',ue,fe);fe={setState:se,style:"text-decoration:underline",removeStyle:"text-decoration:none"};const ge=new A("style","U","Underline",'<i class="bi bi-type-underline"></i>',ue,fe);fe={setState:se,style:"CLEAR"};const me=new A("style","CLEAR","Clear",'<i class="bi bi-eraser"></i>',ue,fe);let be,ye="",ve=null,Ce="",Le="";function Ee(){ve.remove(),ve=null}function Ne(e){let t=be.range.startContainer.textContent,n=be.range.startOffset,o=t.substring(0,n),r=t.substring(n);"@"===r.charAt(0)&&(r=r.slice(1,r.length-1)),32!==t.charCodeAt(n-1)&&(e=" "+e),n<t.length&&32!==t.charCodeAt(n)&&(""!=r&&(r+=" "),e+=" "),be.range.startContainer.textContent=o+e+r,n+=e.length,be.range=T(be.range.startContainer,n),Ee(),be.bufferUpdate(be)}const Se=function(e){e=e.sort(),ye="",e.forEach((e=>{ye+=`<option>${e}</option>`}))},ke=new A("custom","mention","Mention",'<i class="bi bi-person"></i>',(function(e,t){if(!1===e.range)return void console.log("No range selected");be=e,ve=document.createElement("DIV"),ve.id="mentions",ve.classList.add("inplace-panel"),ve.innerHTML=`\n        <div class="inplace-content">\n            <input list="people-list" type="text"/>\n            <datalist id="people-list">${ye}</datalist>\n        </div>`,Ce=ve.querySelector("input"),Ce.addEventListener("keyup",(e=>function(e){e.stopPropagation(),"Escape"==e.key?Ee():"Enter"==e.key&&Ne(Ce.value.trim())}(e))),Le="",Ce.addEventListener("input",(e=>{const t=Ce.value.trim();t.length-Le.length>1&&Ne(t),Le=t})),document.querySelector("body").appendChild(ve);let n=document.querySelector(".inplace-content");const o=function(e){let t;return t=3!==be.range.startContainer.nodeType?be.range.startContainer.childNodes.length>0?be.range.startContainer.childNodes[0].getBoundingClientRect():{x:be.editorNode.offsetLeft,y:be.editorNode.offsetTop}:be.range.getBoundingClientRect(),t.x+e.outerWidth>window.innerWidth&&(t.x=window.innerWidth-e.outerWidth-20),t.y+e.outerHeight>window.innerHeight&&(t.y=window.innerHeight-e.outerHeight-40),t}(n);n.style.top=`${o.y}px`,n.style.left=`${o.x}px`,Ce.focus()}),{setState:function(e,t){!1===e.range||0==e.range.collapsed&&e.range.startContainer!=e.range.endContainer?(t.element.disabled=!0,t.element.classList.remove("active")):(t.element.disabled=!1,t.element.classList.add("active"))},shortcut:["@","Tab"]});let Te=null;const we=function(){Te.classList.remove("show"),setTimeout((()=>{Te.remove(),Te=null}),500)},xe=function(e,t,n,o){return null==n&&(n="No - stay here"),null==o&&(o="Yes - lose changes"),Te=document.createElement("DIV"),Te.classList.add("modal-panel"),Te.innerHTML=function(e,t,n,o){return null==n&&(n="No - stay here"),null==o&&(o="Yes - lose changes"),`\n        <div class="modal-panel-container">\n            <header class="modal-panel-header">\n                <h3 class="modal-panel-title">${e}</h3>\n            </header>\n            <div class="modal-panel-message">${t}</div>\n            <div class="modal-panel-buttons">\n                <button type="button" class="cancel">${n}</button>\n                <button type="button" class="confirm">${o}</button>\n            </div>\n        </div>`}(e,t,n,o),Te.querySelector("button.cancel").addEventListener("click",(e=>{e.stopPropagation(),we()})),document.querySelector("body").appendChild(Te),setTimeout((()=>{Te.classList.add("show")}),10),Te.querySelector("button.confirm")},qe="A";let Ae,Oe,He=null;function Ie(e,t,n){He||(Ae=n,$e(e,t,"",!0))}function $e(e,t,n,o){0==o&&(Ae=document.createElement(qe),Ae.id=q(),Ae.setAttribute("contenteditable","false"),Ae.href="",Ae.dataset.label=n,Ae.dataset.display=0),He=document.createElement("DIV"),He.id="link-edit",He.classList.add("edit-panel"),He.innerHTML=function(e){let t="Create link",n="",o="",r="http://",a=Ae.dataset.label,i=Ae.dataset.display?Ae.dataset.display:0;return e&&(t="Edit link",r=Ae.href,n='<button type="button" class="delete">Delete</button>',o=`<a href="${r}" class="panel-link" target="_blank" title="Open link in new tab or window"><i class="bi bi-link-45deg"></i></a>`),`\n        <div class="edit-panel-container">\n            <div class="edit-panel-header">\n                <h3 class="edit-panel-title">${t}</h3>\n            </div>\n            <div class="edit-panel-body">\n                <form>\n                    <div class="form-input">\n                        <label for="href">URL</label>\n                        <input id="href" type="url" class="form-control ${o?"with-button":""}" placeholder="URL" required value="${r}">\n                        ${o}\n                    </div>\n                    <div class="form-input">\n                        <label for="label">Label (optional)</label>\n                        <input id="label" type="text" class="form-control" placeholder="Label" value="${a}">\n                    </div>\n                    <div class="form-input">\n                        <label for="label">Display option</label>\n                        <select class="form-control" id="display">\n                            <option value="0" ${0==i?"selected":""}>Label only</option>\n                            <option value="1" ${1==i?"selected":""}>Link only</option>\n                            <option value="2" ${2==i?"selected":""}>Label and link</option>\n                        </select>\n                    </div>\n                    <div class="buttons">\n                        <button type="button" class="cancel">Cancel</button>\n                        ${n}\n                        <button type="submit" class="save">Save</button>\n                    </div>\n                </form>\n            </div>\n        </div>`}(o),Oe=!1,He.querySelectorAll("form input").forEach((e=>e.addEventListener("change",(()=>Oe=!0)))),He.querySelector("button.cancel").addEventListener("click",(()=>{Oe?xe("Cancel changes","Do you really want to lose these changes?").addEventListener("click",(()=>{we(),De()})):De()})),o&&He.querySelector("button.delete").addEventListener("click",(()=>{xe("Delete link","Do you really want to delete this link?").addEventListener("click",(()=>{we(),function(e,t){Ae.remove(),De(),e.range=!1,Pe(e,t)}(e,t)}))})),He.querySelector("form").addEventListener("submit",(n=>{n.preventDefault(),function(e,t,n){Ae.href=He.querySelector("form #href").value.trim(),Ae.dataset.label=He.querySelector("form #label").value.trim(),Ae.dataset.display=parseInt(He.querySelector("form #display").value),0==n&&function(e){const t=e.range.startContainer.parentNode;let n,o=e.range.startContainer.textContent.substring(0,e.range.startOffset);e.range.collapsed?(n=e.range.startContainer.textContent.substring(e.range.startOffset)," "!=o.charAt(o.length+1)&&(o+=" ")," "!=n.charAt(0)&&(n=" "+n)):n=e.range.startContainer.textContent.substring(e.range.endOffset),o&&t.insertBefore(document.createTextNode(o),e.range.startContainer),Ae=t.insertBefore(Ae,e.range.startContainer),n&&t.insertBefore(document.createTextNode(n),e.range.startContainer),e.range.startContainer.remove()}(e),Me(e,t,Ae),De(),e.range=T(Ae,0),Pe(e,t)}(e,t,o)})),document.querySelector("body").appendChild(He);const r=He.querySelector("form #href");r.focus(),r.setSelectionRange(r.value.length,r.value.length),setTimeout((()=>He.classList.add("show")),10)}function De(){He.classList.remove("show"),setTimeout((()=>{He.remove(),He=null}),500)}function Me(e,t,n){0==n.id&&(n.id=q()),n.setAttribute("contenteditable",!1),n.title="Click to edit",n.innerText=function(e){switch(parseInt(e.dataset.display)){case 0:if(e.dataset.label)return e.dataset.label;break;case 1:return e.href;case 2:if(e.dataset.label&&e.dataset.label!=e.href)return`${e.dataset.label} (${e.href})`}return e.href}(n),n.addEventListener("click",(o=>{o.preventDefault(),o.stopPropagation(),Ie(e,t,n)}))}const Pe=function(e,t){!1===e.range||0==e.range.collapsed&&e.range.startContainer!=e.range.endContainer?(t.element.disabled=!0,t.element.classList.remove("active")):(t.element.disabled=!1,null!=e.range.blockParent.querySelector(qe)?t.element.classList.add("active"):t.element.classList.remove("active"))},Re=new A("custom",qe,"Link",'<i class="bi bi-link"></i>',(function(e,t){if(console.log("click link"),!1===e.range)return void console.log("No range selected");let n="";0==e.range.collapsed&&e.range.startContainer==e.range.endContainer&&(n=e.range.endContainer.textContent.substring(e.range.startOffset,e.range.endOffset)),$e(e,t,n,!1)}),{init:function(e,t){e.editorNode.querySelectorAll(qe).forEach((n=>Me(e,t,n)))},setState:Pe,addEventHandlers:function(e){e.editorNode.querySelectorAll(qe).forEach((t=>t.addEventListener("click",(n=>{n.preventDefault(),n.stopPropagation(),Ie(e,Re,t)}))))},clean:function(e){return console.log("clean link",e),e.removeAttribute("id"),e.removeAttribute("contenteditable"),e.innerText=" ",e}}),Fe=function(e,t){!1===e.range||e.range.collapsed?console.log("No non-collapsed range selected"):function(e,t){const n=document.createElement("input");n.type="color",n.style="display:none;",document.body.appendChild(n),n.click(),n.addEventListener("input",(o=>{console.log("colour changed",o.target.value);const r=o.target.value,a={setState:Be,style:`${t.style}:${r}`,removeStyle:t.removeStyle,element:t.element};ue(e,a),function(e){e.remove()}(n)}))}(e,t)},Be=function(e,t){if(!1===e.range)t.element.disabled=!0,t.element.classList.remove("active");else if("CLEAR"==t.tag)t.element.disabled=!1,t.element.classList.remove("active");else{t.element.disabled="DIV"===e.range.rootNode.tagName||u(e.range.rootNode)||h(e.range.rootNode);let n="",o=[];const r=e.range.startContainer.parentNode.getAttribute("style");null!=r&&(o=r.split(";"),o.forEach((e=>{if(""!==e){const o=e.split(":");o[0].trim()===t.style&&(n=o[1].trim(),t.element.querySelector("span.bar").setAttribute("style",`background-color:${n};`))}}))),""==n&&t.element.querySelector("span.bar").removeAttribute("style")}},Ue=function(e,t){const n=document.createElement("span");n.classList.add("bar"),n.classList.add(t.tag),t.element.appendChild(n),t.element.classList.add("barred")};let Ke={init:Ue,setState:Be,style:"color",removeStyle:"color:black;"};const je=new A("inline","FGC","Foreground colour",'<i class="bi bi-type"></i>',Fe,Ke);Ke={init:Ue,setState:Be,style:"background-color",removeStyle:"background-color:white;"};const Ve=new A("inline","BGC","Background colour",'<i class="bi bi-paint-bucket"></i>',Fe,Ke),ze="CUSTOM";let Ge,We,Ye=null;function _e(e,t,n){Ye||(Ge=n,Qe(e,t,!0))}function Qe(e,t,n){0==n&&(Ge=document.createElement(ze),Ge.id=q(),Ge.setAttribute("contenteditable","false"),Ge.innerHTML=Ze({property1:" ",property2:" ",property3:" "})),Ye=document.createElement("DIV"),Ye.id="custom-edit",Ye.classList.add("edit-panel");const o={property1:Ge.querySelector(".property1").innerText,property2:Ge.querySelector(".property2").innerText,property3:Ge.querySelector(".property3").innerText};Ye.innerHTML=function(e,t){let n="Create custom element",o="";return t&&(n="Edit custom element",o='<button type="button" class="delete">Delete</button>'),`\n        <div class="edit-panel-container">\n            <div class="edit-panel-header">\n                <h3 class="edit-panel-title">${n}</h3>\n            </div>\n            <div class="edit-panel-body">\n                <form>\n                    <div class="form-input">\n                        <label for="property1">Property 1</label>\n                        <input id="property1" type="text" class="form-control" placeholder="Property 1" required value="${e.property1}">\n                    </div>\n                    <div class="form-input">\n                        <label for="property2">Property 2</label>\n                        <input id="property2" type="text" class="form-control" placeholder="Property 2" required value="${e.property2}">\n                    </div>\n                    <div class="form-input">\n                        <label for="property3">Property 3</label>\n                        <input id="property3" type="text" class="form-control" placeholder="Property 3" required value="${e.property3}">\n                    </div>\n                    <div class="buttons">\n                        <button type="button" class="cancel">Cancel</button>\n                        ${o}\n                        <button type="submit" class="save">Save</button>\n                    </div>\n                </form>\n            </div>\n        </div>`}(o,n),We=!1,Ye.querySelectorAll("form input").forEach((e=>e.addEventListener("change",(()=>We=!0)))),Ye.querySelector("button.cancel").addEventListener("click",(()=>{We?xe("Cancel changes","Do you really want to lose these changes?").addEventListener("click",(()=>{we(),Je()})):Je()})),n&&Ye.querySelector("button.delete").addEventListener("click",(()=>{xe("Delete custom item","Do you really want to delete this custom item?","No - keep","Yes - delete").addEventListener("click",(()=>{we(),function(e,t){Ge.remove(),Je(),e.range=!1,et(e,t)}(e,t)}))})),Ye.querySelector("form").addEventListener("submit",(o=>{o.preventDefault(),function(e,t,n){Ge.querySelector(".property1").innerText=Ye.querySelector("form #property1").value.trim(),Ge.querySelector(".property2").innerText=Ye.querySelector("form #property2").value.trim(),Ge.querySelector(".property3").innerText=Ye.querySelector("form #property3").value.trim(),0==n&&function(e){Ge=e.range.startContainer.parentNode.appendChild(Ge)}(e),Xe(e,t,Ge),Je(),e.range=T(Ge,0),et(e,t)}(e,t,n)})),document.querySelector("body").appendChild(Ye);const r=Ye.querySelector("form #property1");r.focus(),r.setSelectionRange(r.value.length,r.value.length),setTimeout((()=>Ye.classList.add("show")),10)}function Je(){Ye.classList.remove("show"),setTimeout((()=>{Ye.remove(),Ye=null}),500)}function Xe(e,t,n){n.id,0==n.id&&(n.id=q());const o={property1:n.querySelector(".property1").innerText,property2:n.querySelector(".property2").innerText,property3:n.querySelector(".property3").innerText};n.innerHTML=Ze(o),n.setAttribute("contenteditable",!1);const r=document.createElement("button");r.type="button",r.classList.add("edit"),r.innerText="Edit",r.addEventListener("click",(o=>{o.preventDefault(),o.stopPropagation(),_e(e,t,n)})),n.appendChild(r),n.addEventListener("click",(()=>{et(e,t)}))}function Ze(e){return`\n        <span class="title">I am a custom object with 3 properties:</span>\n        <span class="label">Property 1:</span><span class="prop property1">${e.property1}</span>\n        <span class="label">Property 2:</span><span class="prop property2">${e.property2}</span>\n        <span class="label">Property 3:</span><span class="prop property3">${e.property3}</span>\n        <span class="advice">Click the top right-hand button to edit. Select anywhere in the element and then the Enter key to add a new line after this custom element.</span>\n    `}const et=function(e,t){!1===e.range||0==e.range.collapsed&&e.range.startContainer!=e.range.endContainer?(t.element.disabled=!0,t.element.classList.remove("active")):(t.element.disabled=!1,null!=e.range.blockParent.querySelector(ze)?t.element.classList.add("active"):t.element.classList.remove("active"))},tt=new A("custom",ze,"Custom",'<i class="bi bi-plug"></i>',(function(e,t){const n=e.range.blockParent.querySelector(ze);null!=n?_e(e,t,n):Qe(e,t,!1)}),{setState:et,init:function(e,t){e.editorNode.querySelectorAll(ze).forEach((n=>Xe(e,t,n)))},addEventHandlers:function(e){e.editorNode.querySelectorAll("CUSTOM button").forEach((t=>t.addEventListener("click",(n=>{n.preventDefault(),n.stopPropagation();const o=t.parentNode;_e(e,tt,o)}))))},clean:function(e){return console.log("clean custom element",e),e.removeAttribute("contenteditable"),e.querySelector(".title").remove(),e.querySelector(".advice").remove(),e.querySelector(".label").remove(),e.querySelector("button").remove(),e}}),nt={Editor:class{constructor(e,t,n,o){this.options=this.initOptions(o),this.initBuffering(t),this.toolbar=this.initToolbar(n),e.innerHTML=function(e,t){const n=function(e){let t="",n=[];return e.forEach(((o,r)=>{t+=function(e){const{type:t,tag:n,label:o,icon:r}=e;return`\n        <button id="${n}" type="button" class="btn btn-light ${t}" title="${o}">\n            ${r}\n        </button>`}(o);const a=r==e.length-1?"":e[r+1].group;if(o.group!=a){const e=`${o.group} buttons`;n.push(function(e,t){return`<div class="editor-toolbar-group block" role="group" title="${e}">${t}</div>`}(e,t)),t=""}})),n.join('<span class="editor-toolbar-group-separator">|</span>')}(e);let o="";return"on"==t.headingNumbers&&(o+="heading-numbers"),`\n        <div class="editor-container">\n            <div class="editor-toolbar">\n                ${n}\n            </div>\n            <div class="editor-body ${o}" contenteditable="true">\n                ...\n            </div>\n        </div>`}(this.toolbar,this.options),this.editorNode=e.querySelector(".editor-body"),this.toolbarNode=e.querySelector(".editor-toolbar"),this.editorNode.innerHTML=t,this.range=!1,this.listenForMouseUpEvents(),this.listenForPasteEvents(),this.listenForKeydownEvents(),this.initialiseButtons(),this.options.bufferSize>0&&(this.bufferIndex=0,this.buffer=[this.editorNode.innerHTML],this.listenForKeyupEvents()),this.save=this.getCleanData,this.update=this.updateEditor,new MutationObserver((()=>this.handleMutation())).observe(this.editorNode,{attributes:!1,childList:!0,subtree:!0})}handleMutation(){!1===this.bufferIgnoreMutation(this)&&(this.bufferUpdate(this),this.updateEventHandlers())}initBuffering(){this.bufferIndex=-1,this.buffer=[],this.bufferIgnore=!1,this.bufferUpdate=H,this.bufferIgnoreMutation=I}initOptions(e){return e?(e.headingNumbers=void 0!==e.headingNumbers?e.headingNumbers:"off",e.bufferSize=void 0!==e.bufferSize?Math.max(parseInt(e.bufferSize),10):10):e={headingNumbers:"off",bufferSize:10},e}initToolbar(e){let t=[];return e.forEach(((e,n)=>{e.forEach((e=>{var o,r;e.group=n,o=e.type,r=e.tag,null!=c[o]&&0==c[o].includes(r)&&"CLEAR"!=r&&c[o].push(r),t.push(e)}))})),t}setState(e){"setState"in e?e.setState(this,e):(!1===this.range?e.element.disabled=!0:e.element.disabled=!1,e.element.classList.remove("active"))}initialiseButtons(){this.shortcuts=[],this.toolbar.forEach((e=>{e.element=this.toolbarNode.querySelector(`#${e.tag}`),"init"in e&&e.init(this,e),this.setState(e),"shortcut"in e&&(e.shortcut[0],e.shortcut[1],this.shortcuts.push({shortcut:e.shortcut[0],trigger:e.shortcut[1],button:e})),e.element.addEventListener("click",(t=>{!1!==this.range||"buffer"===e.type?e.click(this,e):t.preventDefault()}))}))}listenForMouseUpEvents(){document.addEventListener("mouseup",(e=>{if(this.nodeInEditor(e.target))this.handleMouseUp();else{if(this.nodeInToolbar(e.target))return;this.handleEditorBlur()}}))}handleEditorBlur(e){0==document.querySelectorAll(".show").length&&(console.log("editor blurred"),this.toolbar.forEach((e=>{this.range=!1,this.setState(e)})))}nodeInEditor(e){for(;3==e.nodeType||"HTML"!=e.tagName;){if(e==this.editorNode)return!0;e=e.parentNode}return!1}nodeInToolbar(e){for(;3==e.nodeType||"HTML"!=e.tagName;){if(e==this.toolbarNode)return!0;e=e.parentNode}return!1}setToolbarStates(){!1!==this.range?this.toolbar.forEach((e=>{this.setState(e)})):this.toolbar.forEach((e=>{e.element.classList.remove("active")}))}handleMouseUp(){if(this.updateRange(),!1!==this.range){this.bufferIgnore=!1,this.range.blockParent==this.editorNode&&""==this.editorNode.innerText&&this.insertParagraph();const e=p(this.range);this.highlightCustomNode(e)}this.setToolbarStates()}insertParagraph(){let e=document.createElement("P");e.innerText="\n",e=this.editorNode.appendChild(e),T(e,0)}listenForKeydownEvents(){this.lastKey="",this.editorNode.addEventListener("keydown",(e=>{let t=!1;if(console.log("control key?",e.ctrlKey),console.log("key",e.key),document.querySelectorAll(".show").length>0&&(e.preventDefault(),t=!0),t||"Enter"!=e.key||(this.handleEnter()&&e.preventDefault(),t=!0),!t&&("Backspace"==e.key||"Delete"==e.key||e.ctrlKey&&"d"==e.key)&&(this.handleDelete(e.key)&&e.preventDefault(),t=!0),t||this.shortcuts.forEach((n=>{this.lastKey===n.shortcut&&e.key===n.trigger&&(e.preventDefault(),e.stopPropagation(),n.button.click(this,n.button),t=!0)})),!t&&this.bufferSize>0&&(e.ctrlKey||e.metaKey)&&"z"==e.key){let n;e.preventDefault(),n=e.shiftKey?this.toolbar.find((e=>"REDO"==e.tag)):this.toolbar.find((e=>"UNDO"==e.tag)),this.buffer.click(n),this.updateEventHandlers(),t=!0}this.lastKey=e.key}))}handleEnter(){if(this.updateRange(),!1===this.range)return;const e=p(this.range),t=this.range.endContainer.textContent.trim().length==this.range.endOffset;let n=!1;if(e||t){console.log(`Creating a ${this.range.blockParent.tagName} node`);let e=document.createElement(this.range.blockParent.tagName);e.innerText="\n",o=e,e=(r=this.range.blockParent).parentNode.insertBefore(o,r.nextSibling),T(e,0),n=!0}var o,r;return e&&this.highlightCustomNode(!1),this.updateRange(),n}handleDelete(e){if("d"==e&&(e="Delete"),this.updateRange(),this.range){const t="Information",n="To delete a custom element you need to edit it by clicking it and choosing Delete.";if(this.range.collapsed){if(console.log("Single selection"),console.log("range length",this.range.endContainer.textContent.trim().length),console.log("range endOffset",this.range.endOffset),"Backspace"==e&&0==this.range.startOffset){const e=this.range.blockParent.previousElementSibling;if(e&&e.innerHTML.includes('contenteditable="false"'))return R(t,n),!0}else if("Delete"==e&&this.range.endContainer.textContent.trim().length==this.range.endOffset){console.log("Deleting from end container");const e=this.range.endContainer.nextElementSibling;if(console.log("next",e),e&&"false"==e.getAttribute("contenteditable"))return R(t,n),!0}}else{let e=g(this.range.startContainer);const o=g(this.range.endContainer);for(;e!==o;){if(e.innerHTML.includes('contenteditable="false"'))return R(t,n),!0;e=e.nextElementSibling}}}return!1}listenForKeyupEvents(){this.handleKeyup=function(e,t){let n;return function(...t){n&&clearTimeout(n),n=setTimeout((()=>{e(...t)}),500)}}(this.handleKeyupDelayed),this.editorNode.addEventListener("keyup",(e=>{console.log("handle key up event",e),0==["Shift"].includes(e.key)&&(this.bufferIgnore=!0,this.handleKeyup(e.key,this))}))}handleKeyupDelayed(...e){let t=e[0];const n=e[1];["ArrowDown","ArrowUp","ArrowLeft","ArrowRight","End","Home"].includes(t)?(n.range=k(),n.setToolbarStates()):0==document.querySelectorAll(".show").length&&n.bufferUpdate(n)}updateEventHandlers(){this.toolbar.forEach((e=>{"addEventHandlers"in e&&e.addEventHandlers(this)}))}listenForPasteEvents(){["cut","copy","paste"].forEach((e=>this.editorNode.addEventListener(e,(e=>{this.handleCutCopyPaste()&&e.preventDefault()}))))}handleCutCopyPaste(){if(console.log("Detected cut-copy-paste event"),this.updateRange(),0==this.range||this.range.collapsed)return!1;let e=g(this.range.startContainer);const t=g(this.range.endContainer);let n=!1;for(;!n;){if(e.innerHTML.includes('contenteditable="false"'))return R("Information","Cut, copy and paste (of/over) selections with custom elements is not supported. Please modify your selection and try again."),!0;e=e.nextElementSibling,e===t&&(n=!0)}return!1}getCleanData(){let e=this.editorNode.cloneNode(!0);const t=this.toolbar.filter((e=>"custom"===e.type));return b(e,t),e.innerHTML=e.innerHTML.replace(/[\n ]*?</gm,"<"),e.innerHTML}updateEditor(e){this.editorNode.innerHTML=e}updateRange(){this.range=k(),function(e){const t=document.getElementById("debug");if(null==t)return"";t.innerHTML=!1===e?"No range selected":`\n            <h5>Selection info:</h5>\n            <div class="debug">\n                <div class="col">\n                    <label>Block parent</label><span>${e.blockParent.tagName}</span>\n                    <label>commonAncestorC</label><span>${e.commonAncestorContainer.tagName?e.commonAncestorContainer.tagName:e.commonAncestorContainer.textContent}</span>\n                    <label>rootNode</label><span>${e.rootNode.tagName}</span>\n                    <label>collapsed</label><span>${e.collapsed}</span>\n                </div>\n                <div class="col">\n                    <label>startC</label><span>${e.startContainer.tagName?e.startContainer.tagName:e.startContainer.textContent}</span>\n                    <label>startOffset</label><span>${e.startOffset}</span>\n                    <label>endC</label><span>${e.endContainer.tagName?e.endContainer.tagName:e.endContainer.textContent}</span>\n                    <label>endOffset</label><span>${e.endOffset}</span>\n                </div>\n            </div>`}(this.range)}highlightCustomNode(e){this.editorNode.querySelectorAll("[contenteditable=false]").forEach((e=>e.classList.remove("selected"))),e&&e.classList.add("selected")}},Buffer:n,Blocks:o,Styles:r,Mentions:a,Links:i,Colours:l,Custom:s};return t})()}));